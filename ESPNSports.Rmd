---
title: "Does analytics work in professional sports?"
author: "Walt DeGrange"
date: "November 11, 2020"
output:
  html_document: default
  pdf_document: default
---

==

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE ,warning = FALSE,message = FALSE)
```

```{r Libraries}
library(dplyr)
library(tidyr)
library(magrittr)
library(ggplot2)
library(purrr)
library(ggforce)
library(fpc)
library(cluster) 
library(mclust)
library(kableExtra)
library(formattable)
library(stargazer)
library(formatR)
# library(lares)
```

# Sports Analytics - Does it make a difference?

Salary Data - <https://www.spotrac.com>

```{r Data Import}
TeamData <- read.csv("ESPNSportsAnalytics.csv")

colnames(TeamData)[1] <- "Sport"

```

```{r Create data tables, tidy=TRUE, tidy.opts=list(width.cutoff=60)}

TeamData %<>% mutate(PopulationMil = digits(Market/1000000,1))

TeamDataKM2015 <- TeamData %>% select(ESPNRating,X2014HF,X2015HF,X2015Salary,PopulationMil)

TeamDataKM2016 <- TeamData %>% select(ESPNRating,X2014HF,X2015HF,X2016Salary,X2016HF,PopulationMil)

TeamDataKM2017 <- TeamData %>% select(ESPNRating,X2014HF,X2015HF,X2016HF,X2017Salary,X2017HF,PopulationMil)

TeamDataKM2018 <- TeamData %>% select(ESPNRating,X2014HF,X2015HF,X2016HF,X2017HF,X2018Salary,X2018HF, PopulationMil)

TeamDataKM2019 <- TeamData %>% select(ESPNRating,X2014HF,X2015HF,X2016HF,X2017HF,X2018Salary,X2018HF,X2019HF, PopulationMil)

```

## Overall

```{r, tidy=TRUE, tidy.opts=list(width.cutoff=60)}

TeamDataNew <- TeamData %>% group_by(Team) %>% mutate(HowFar = sum(X2014HF,X2015HF,X2016HF,X2017HF,X2018HF,X2019HF)/6)

TeamDataNew$HowFar[TeamDataNew$Team == "Golden Knights"] <- 5/2

TeamDataNew %>% group_by(Sport) %>% summarise(count = n(), MeanESPN = digits(mean(ESPNRating),1), StdESPN = digits(sd(ESPNRating),1)) %>% kable() %>% kable_styling(c("striped","condensed"), full_width = F) %>% column_spec(column = 1:2, color = "black")
```

## Local Teams

```{r Local Teams, tidy=TRUE, tidy.opts=list(width.cutoff=60)}

TeamDataNew %>% 
  filter(City %in% c("Dallas", "Kansas City", "Memphis")) %>% 
           group_by(City,Sport,Team,HowFar)  %>% 
           summarise(count = n(), ESPN = ESPNRating) %>% 
           select(City,Team,ESPN,HowFar) %>% 
           kable() %>% 
           kable_styling(c("striped","condensed"), full_width = F) %>% 
           column_spec(column = 1:2, color = "black")


```

------------------------------------------------------------------------

# Champions

## 2014

```{r 2014, tidy=TRUE, tidy.opts=list(width.cutoff=60)}
TeamDataNew %>% filter(X2014HF == "5") %>%  select(Sport,Team,City,ESPNRating,PopulationMil) %>%  arrange(Sport) %>% head(10) %>%  kable() %>% kable_styling(c("striped","condensed"), full_width = F) %>% column_spec(column = 1:2, color = "black")
```

## 2015

```{r 2015, tidy=TRUE, tidy.opts=list(width.cutoff=60)}
TeamDataNew %>% filter(X2015HF == "5") %>%  select(Sport,Team,City,ESPNRating,PopulationMil) %>%  arrange(Sport) %>% head(10) %>%  kable() %>% kable_styling(c("striped","condensed"), full_width = F) %>% column_spec(column = 1:2, color = "black")
```

## 2016

```{r 2016, tidy=TRUE, tidy.opts=list(width.cutoff=60)}
TeamDataNew %>% filter(X2016HF == "5") %>%  select(Sport,Team,City,ESPNRating,PopulationMil) %>%  arrange(Sport) %>% head(10) %>%  kable() %>% kable_styling(c("striped","condensed"), full_width = F) %>% column_spec(column = 1:2, color = "black")
```

## 2017

```{r 2017, tidy=TRUE, tidy.opts=list(width.cutoff=60)}
TeamDataNew %>% filter(X2017HF == "5") %>%  select(Sport,Team,City,ESPNRating,PopulationMil) %>%  arrange(Sport) %>% head(10) %>%  kable() %>% kable_styling(c("striped","condensed"), full_width = F) %>% column_spec(column = 1:2, color = "black")
```

## 2018

```{r 2018, tidy=TRUE, tidy.opts=list(width.cutoff=60)}
TeamDataNew %>% filter(X2018HF == "5") %>%  select(Sport,Team,City,ESPNRating,PopulationMil) %>%  arrange(Sport) %>% head(10) %>%  kable() %>% kable_styling(c("striped","condensed"), full_width = F) %>% column_spec(column = 1:2, color = "black")
```

## 2019

```{r 2019, tidy=TRUE, tidy.opts=list(width.cutoff=60)}
TeamDataNew %>% filter(X2019HF == "5") %>%  select(Sport,Team,City,ESPNRating,PopulationMil) %>%  arrange(Sport) %>% head(10) %>%  kable() %>% kable_styling(c("striped","condensed"), full_width = F) %>% column_spec(column = 1:2, color = "black")
```

------------------------------------------------------------------------

## Team list grouped by ESPN Ranking

```{r ESPN Rank, tidy=TRUE, tidy.opts=list(width.cutoff=60)}

TeamDataNew$PopulationMil <- digits(TeamDataNew$PopulationMil,1)

TeamDataNew %>% group_by(ESPNRating) %>% summarise(Count = n(), HowFar = digits(sum(X2014HF,X2015HF,X2016HF,X2017HF,X2018HF)/(5*n()),1), MeanPop = digits(mean(PopulationMil),1), MeanSalary = digits(sum(X2014Salary,X2015Salary,X2016Salary,X2017Salary,X2018Salary,X2019Salary)/(6*n()),1)) %>% kable() %>% kable_styling(c("striped","condensed"), full_width = F) %>% column_spec(column = 1:2, color = "black")
```

## Ten best ESPN Rating performers

```{r ESPN Best Performers, tidy=TRUE, tidy.opts=list(width.cutoff=60)}
TeamDataNew %>% select(Sport,Team,City,ESPNRating,PopulationMil,HowFar) %>% arrange(-HowFar) %>% head(10, ESPNRating)  %>% kable() %>% kable_styling(c("striped","condensed"), full_width = F) %>% column_spec(column = 1:2, color = "black")

```

\medskip

## Ten bottom ESPN Rating performers

```{r Bottom 10, tidy=TRUE, tidy.opts=list(width.cutoff=60)}

TeamDataNew %>% select(Sport,Team,City,ESPNRating,PopulationMil,HowFar) %>%  arrange(-ESPNRating,HowFar) %>% head(10) %>%  kable() %>% kable_styling(c("striped","condensed"), full_width = F) %>% column_spec(column = 1:2, color = "black")
```

------------------------------------------------------------------------

## Data Summary

```{r Market Summary,results='asis, tidy=TRUE, tidy.opts=list(width.cutoff=60)'}
TeamDataDF <- TeamData %>% select(c(ESPNRating,PopulationMil)) %>%  data.frame()
ESPNTable <- stargazer(TeamDataDF, type="html", align = TRUE, digits=1)
```

## Big to Small Market Teams

### Los Angeles

```{r Big to Small Market, tidy=TRUE, tidy.opts=list(width.cutoff=60)}

TeamDataNew %>% group_by(Sport,Team,HowFar) %>% filter(City %in% c("Los Angeles","Anaheim")) %>%  summarise(count = n(), ESPN = (ESPNRating)) %>% select(Team,ESPN,HowFar) %>% kable() %>% kable_styling(c("striped","condensed"), full_width = F) %>% column_spec(column = 1:2, color = "black")


```

### New York

```{r New York, tidy=TRUE, tidy.opts=list(width.cutoff=60)}
TeamDataNew %>% group_by(Sport,Team,HowFar) %>% filter(City %in% c("New York")) %>%  summarise(count = n(), ESPN = (ESPNRating)) %>% select(Team,ESPN,HowFar) %>% kable() %>% kable_styling(c("striped","condensed"), full_width = F) %>% column_spec(column = 1:2, color = "black")


```

### Green Bay

```{r Green Bay, tidy=TRUE, tidy.opts=list(width.cutoff=60)}
TeamDataNew %>% group_by(Sport,Team,HowFar) %>% filter(City %in% c("Green Bay")) %>%  summarise(count = n(), ESPN = (ESPNRating)) %>% select(Team,ESPN,HowFar) %>% kable() %>% kable_styling(c("striped","condensed"), full_width = F) %>% column_spec(column = 1:2, color = "black")
```

## Plot of ESPN vs How Far a team made it into the playoffs on average for the 4 years of data

```{r Plots, tidy=TRUE, tidy.opts=list(width.cutoff=60)}

TeamDataNew %>% ggplot(aes(x=ESPNRating,y=HowFar)) +
  geom_point()+
  geom_smooth()


```

## K Means clustering 2019

```{r KMeans Cluster 2019, tidy=TRUE, tidy.opts=list(width.cutoff=60)}

TeamDataKM2019 <- scale(TeamDataKM2019)

fit <- kmeans(TeamDataKM2019, 2)

TeamDataKM2019 <- data.frame(TeamDataKM2019, fit$cluster)

TeamData2019 <- data.frame(TeamData, fit$cluster)

rownames(TeamData2019) <- paste(TeamData2019$Sport,TeamData2019$Team,sep="")

clusplot(TeamData2019, fit$cluster, color=TRUE, shade=FALSE, 
  	labels=2, lines=0, cex.txt = .5,col.clus = c("red", "green"),col.txt = c("black", "black"))

TeamData2019 %>% group_by(TeamData2019$fit.cluster) %>% summarise(count=n(),MeanX2014HF = digits(mean(X2014HF),1),MeanX2015HF = digits(mean(X2015HF),1),MeanX2016HF = digits(mean(X2016HF),1),MeanX2017HF = digits(mean(X2017HF),1),MeanX2018HF = digits(mean(X2018HF),1),MeanX2019HF = digits(mean(X2019HF),1),MeanPopulation = digits(mean(PopulationMil),1),MeanSalary = digits(mean(X2019Salary),1),MeanESPNRating = digits(mean(ESPNRating),1)) %>% kable(format="html") %>% kable_styling(c("striped","condensed"), full_width = F, latex_options="scale_down") %>% column_spec(column = 1:2, color = "black")
```

## K Means clustering 2018

```{r KMeans Cluster 2018, tidy=TRUE, tidy.opts=list(width.cutoff=60)}

TeamDataKM2018 <- scale(TeamDataKM2018)

fit <- kmeans(TeamDataKM2018, 2)

TeamDataKM2018 <- data.frame(TeamDataKM2018, fit$cluster)

TeamData2018 <- data.frame(TeamData, fit$cluster)

rownames(TeamData2018) <- paste(TeamData2018$Sport,TeamData2018$Team,sep="")

clusplot(TeamData2018, fit$cluster, color=TRUE, shade=FALSE, 
  	labels=2, lines=0, cex.txt = .5,col.clus = c("red", "green"),col.txt = c("black", "black"))

TeamData2018 %>% group_by(TeamData2018$fit.cluster) %>% summarise(count=n(),MeanX2014HF = digits(mean(X2014HF),1),MeanX2015HF = digits(mean(X2015HF),1),MeanX2016HF = digits(mean(X2016HF),1),MeanX2017HF = digits(mean(X2017HF),1),MeanX2018HF = digits(mean(X2018HF),1),MeanPopulation = digits(mean(PopulationMil),1),MeanSalary = digits(mean(X2018Salary),1),MeanESPNRating = digits(mean(ESPNRating),1)) %>% kable(format="latex") %>% kable_styling(c("striped","condensed"), full_width = F, latex_options="scale_down") %>% column_spec(column = 1:2, color = "black")
```

## K-Means Clustering 2017

```{r KMeans Cluster 2017, tidy=TRUE, tidy.opts=list(width.cutoff=60)}

TeamDataKM2017 <- scale(TeamDataKM2017)

fit <- kmeans(TeamDataKM2017, 2)

TeamDataKM2017 <- data.frame(TeamDataKM2017, fit$cluster)

TeamData2017 <- data.frame(TeamData, fit$cluster)

rownames(TeamData2017) <- paste(TeamData2017$Sport,TeamData2017$Team,sep="")

clusplot(TeamData2017, fit$cluster, color=TRUE, shade=FALSE, 
  	labels=2, lines=0, cex.txt = .5,col.clus = c("red", "green"),col.txt = c("black", "black"))

TeamData2017 %>% group_by(TeamData2017$fit.cluster) %>% summarise(count=n(),MeanX2014HF = digits(mean(X2014HF),1),MeanX2015HF = digits(mean(X2015HF),1),MeanX2016HF = digits(mean(X2016HF),1),MeanX2017HF = digits(mean(X2017HF),1),MeanPopulation = digits(mean(PopulationMil),1),MeanSalary = digits(mean(X2017Salary),1),MeanESPNRating = digits(mean(ESPNRating),1)) %>% kable(format="latex") %>% kable_styling(c("striped","condensed"), full_width = F, latex_options="scale_down") %>% column_spec(column = 1:2, color = "black")
```

## K Means clustering 2016

```{r KMeans Cluster 2016, tidy=TRUE, tidy.opts=list(width.cutoff=60)}

TeamDataKM2016 <- scale(TeamDataKM2016)

fit <- kmeans(TeamDataKM2016, 2)

TeamDataKM2016 <- data.frame(TeamDataKM2016, fit$cluster)

TeamData2016 <- data.frame(TeamData, fit$cluster)

rownames(TeamData2016) <- paste(TeamData2016$Sport,TeamData2016$Team,sep="")

clusplot(TeamData2016, fit$cluster, color=TRUE, shade=FALSE, 
  	labels=2, lines=0, cex.txt = .5,col.clus = c("red", "green"),col.txt = c("black", "black"))

TeamData2016 %>% group_by(TeamData2016$fit.cluster) %>% summarise(count=n(),MeanX2014HF = digits(mean(X2014HF),1),MeanX2015HF = digits(mean(X2015HF),1),MeanX2016HF = digits(mean(X2016HF),1),MeanPopulation = digits(mean(PopulationMil),1),MeanSalary = digits(mean(X2016Salary),1),MeanESPNRating = digits(mean(ESPNRating),1)) %>% kable(format="latex") %>% kable_styling(c("striped","condensed"), full_width = F, latex_options="scale_down") %>% column_spec(column = 1:2, color = "black")
```

## K Means clustering 2015

```{r KMeans Cluster 2015, tidy=TRUE, tidy.opts=list(width.cutoff=60)}

TeamDataKM2015 <- scale(TeamDataKM2015)

fit <- kmeans(TeamDataKM2015, 2)

TeamDataKM2015 <- data.frame(TeamDataKM2015, fit$cluster)

TeamData2015 <- data.frame(TeamData, fit$cluster)

rownames(TeamData2015) <- paste(TeamData2015$Sport,TeamData2015$Team,sep="")

clusplot(TeamData2015, fit$cluster, color=TRUE, shade=FALSE, 
  	labels=2, lines=0, cex.txt = .5,col.clus = c("red", "green"),col.txt = c("black", "black"))

TeamData2015 %>% group_by(TeamData2015$fit.cluster) %>% summarise(count=n(),MeanX2014HF = digits(mean(X2014HF),1),MeanX2015HF = digits(mean(X2015HF),1),MeanPopulation = digits(mean(PopulationMil),1),MeanSalary = digits(mean(X2015Salary),1),MeanESPNRating = digits(mean(ESPNRating),1)) %>% kable(format="latex") %>% kable_styling(c("striped","condensed"), full_width = F, latex_options="scale_down") %>% column_spec(column = 1:2, color = "black")
```

```{r K-Means over time, tidy=TRUE, tidy.opts=list(width.cutoff=60)}

ESPNAnalytics <- data.frame("Year" = c(2015,2016,2017,2018,2019),"High" = c(3.4,3.6,3.9,3.9,4.2),"Low" = c(3.0,2.9,2.7,2.8,2.9))

ESPNAnalytics %>% ggplot() +
  geom_line(aes(x=Year, y=High, color="Green")) +
  geom_line(aes(x=Year, y=Low), color="Dark Blue") +
  scale_x_continuous(breaks = seq(2015,2019, by=1)) +
  scale_y_continuous(limits = c(0,5)) +
  ylab("Mean K-Means Group ESPNAnalytics Score") +
  theme(legend.position="none") 
```
