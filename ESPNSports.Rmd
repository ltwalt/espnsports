---
title: "Does analytics work in professional sports?"
author: "Walt DeGrange"
date: "September 27, 2019"
output:
  html_document: default
  pdf_document: default
---
==


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,warning = FALSE,message = FALSE)
```

```{r Libraries}
library(dplyr)
library(tidyr)
library(magrittr)
library(ggplot2)
library(purrr)
library(ggforce)
library(fpc)
library(cluster) 
library(mclust)
library(kableExtra)
library(formattable)
library(stargazer)
library(lares)
```

# Sports Analytics - Does it make a difference?

```{r Data Import, echo=FALSE}
TeamData <- read.csv("ESPNSportsAnalytics.csv")

colnames(TeamData)[1] <- "Sport"

TeamData %<>% mutate(PopulationMil = digits(Market/1000000,1))

TeamDataKM2017 <- TeamData %>% select(ESPNRating,X2014HF,X2015HF,X2016HF,X2017HF,Market)

TeamDataKM2018 <- TeamData %>% select(ESPNRating,X2014HF,X2015HF,X2016HF,X2017HF,X2018HF, Market)

```

## Overall
```{r}
TeamDataNew <- TeamData %>% group_by(Team) %>% mutate(HowFar = sum(X2014HF,X2015HF,X2016HF,X2017HF,X2018HF)/5)

TeamDataNew$HowFar[TeamDataNew$Team == "Golden Knights"] <- 5/2

TeamDataNew %>% group_by(Sport) %>% summarise(count = n(), MeanESPN = digits(mean(ESPNRating),1), StdESPN = digits(sd(ESPNRating),1)) %>% kable() %>% kable_styling(c("striped","condensed"), full_width = F) %>% column_spec(column = 1:2, color = "black")
```


## Local Teams

```{r Local Teams}

TeamDataNew %>% group_by(City,Sport,Team,HowFar) %>% filter(City %in% c("Washington","Memphis","Las Vegas")) %>% summarise(count = n(), ESPN = ESPNRating) %>% select(City,Team,ESPN,HowFar) %>% kable() %>% kable_styling(c("striped","condensed"), full_width = F) %>% column_spec(column = 1:2, color = "black")


```

_____

# Champions

## 2014

```{r}
TeamDataNew %>% filter(X2014HF == "5") %>%  select(Sport,Team,City,ESPNRating,PopulationMil) %>%  arrange(Sport) %>% head(10) %>%  kable() %>% kable_styling(c("striped","condensed"), full_width = F) %>% column_spec(column = 1:2, color = "black")
```

## 2015

```{r}
TeamDataNew %>% filter(X2015HF == "5") %>%  select(Sport,Team,City,ESPNRating,PopulationMil) %>%  arrange(Sport) %>% head(10) %>%  kable() %>% kable_styling(c("striped","condensed"), full_width = F) %>% column_spec(column = 1:2, color = "black")
```

## 2016

```{r}
TeamDataNew %>% filter(X2016HF == "5") %>%  select(Sport,Team,City,ESPNRating,PopulationMil) %>%  arrange(Sport) %>% head(10) %>%  kable() %>% kable_styling(c("striped","condensed"), full_width = F) %>% column_spec(column = 1:2, color = "black")
```


## 2017

```{r}
TeamDataNew %>% filter(X2017HF == "5") %>%  select(Sport,Team,City,ESPNRating,PopulationMil) %>%  arrange(Sport) %>% head(10) %>%  kable() %>% kable_styling(c("striped","condensed"), full_width = F) %>% column_spec(column = 1:2, color = "black")
```
## 2018

```{r}
TeamDataNew %>% filter(X2018HF == "5") %>%  select(Sport,Team,City,ESPNRating,PopulationMil) %>%  arrange(Sport) %>% head(10) %>%  kable() %>% kable_styling(c("striped","condensed"), full_width = F) %>% column_spec(column = 1:2, color = "black")
```
_____

## Team list grouped by ESPN Ranking

```{r}

TeamDataNew$PopulationMil <- digits(TeamDataNew$PopulationMil,1)

TeamDataNew %>% group_by(ESPNRating) %>% summarise(Count = n(), HowFar = digits(sum(X2014HF,X2015HF,X2016HF,X2017HF)/(4*n()),1), MeanPop = digits(mean(PopulationMil),1)) %>% kable() %>% kable_styling(c("striped","condensed"), full_width = F) %>% column_spec(column = 1:2, color = "black")
```


## Ten best ESPN Rating performers
```{r}
TeamDataNew %>% select(Sport,Team,City,ESPNRating,PopulationMil,HowFar) %>% arrange(-HowFar) %>% head(10, ESPNRating)  %>% kable() %>% kable_styling(c("striped","condensed"), full_width = F) %>% column_spec(column = 1:2, color = "black")

```
\medskip

## Ten bottom ESPN Rating performers
```{r}

TeamDataNew %>% select(Sport,Team,City,ESPNRating,PopulationMil,HowFar) %>%  arrange(-ESPNRating,HowFar) %>% head(10) %>%  kable() %>% kable_styling(c("striped","condensed"), full_width = F) %>% column_spec(column = 1:2, color = "black")
```
____

## Data Summary

```{r Market Summary,results='asis'}
TeamDataDF <- TeamData %>% select(c(ESPNRating,PopulationMil)) %>%  data.frame()
ESPNTable <- stargazer(TeamDataDF, type="html", align = TRUE, digits=1)
```


## Big to Small Market Teams
### Los Angeles
```{r Big to Small Market}

TeamDataNew %>% group_by(Sport,Team,HowFar) %>% filter(City %in% c("Los Angeles","Anaheim")) %>%  summarise(count = n(), ESPN = (ESPNRating)) %>% select(Team,ESPN,HowFar) %>% kable() %>% kable_styling(c("striped","condensed"), full_width = F) %>% column_spec(column = 1:2, color = "black")


```
### New York
```{r}
TeamDataNew %>% group_by(Sport,Team,HowFar) %>% filter(City %in% c("New York")) %>%  summarise(count = n(), ESPN = (ESPNRating)) %>% select(Team,ESPN,HowFar) %>% kable() %>% kable_styling(c("striped","condensed"), full_width = F) %>% column_spec(column = 1:2, color = "black")


```
### Green Bay
```{r}
TeamDataNew %>% group_by(Sport,Team,HowFar) %>% filter(City %in% c("Green Bay")) %>%  summarise(count = n(), ESPN = (ESPNRating)) %>% select(Team,ESPN,HowFar) %>% kable() %>% kable_styling(c("striped","condensed"), full_width = F) %>% column_spec(column = 1:2, color = "black")
```

## Plot of ESPN vs How Far a team made it into the playoffs on average for the 4 years of data

```{r Plots}

TeamDataNew %>% ggplot(aes(x=ESPNRating,y=HowFar)) +
  geom_point()+
  geom_smooth()


```

## K Means clustering

```{r KMeans Cluster}

TeamDataKM2018 <- scale(TeamDataKM2018)

# Determine number of clusters
wss <- (nrow(TeamDataKM2018)-1)*sum(apply(TeamDataKM2018,2,var))
for (i in 2:15) wss[i] <- sum(kmeans(TeamDataKM2018,
  	centers=i)$withinss)
plot(1:15, wss, type="b", xlab="Number of Clusters",
  ylab="Within groups sum of squares")

fit <- kmeans(TeamDataKM2018, 2)

TeamDataKM2018 <- data.frame(TeamDataKM2018, fit$cluster)

TeamData2018 <- data.frame(TeamData, fit$cluster)

rownames(TeamData2018) <- paste(TeamData2018$Sport,TeamData2018$Team,sep="")

clusplot(TeamData2018, fit$cluster, color=TRUE, shade=FALSE, 
  	labels=2, lines=0, cex.txt = .5,col.clus = c("red", "green"),col.txt = c("black", "black"))

TeamData2018 %>% group_by(TeamData2018$fit.cluster) %>% summarise(count=n(),MeanX2014HF = digits(mean(X2014HF),1),MeanX2015HF = digits(mean(X2015HF),1),MeanX2016HF = digits(mean(X2016HF),1),MeanX2017HF = digits(mean(X2017HF),1),MeanX2018HF = digits(mean(X2018HF),1),MeanPopulation = digits(mean(PopulationMil),1),MeanESPNRating = digits(mean(ESPNRating),1)) %>% kable() %>% kable_styling(c("striped","condensed"), full_width = F) %>% column_spec(column = 1:2, color = "black")
```

## K-Means Clustering Multi-Year Analysis

```{r Multi-Year}

TeamData2016 <- TeamData

TeamDataKM2016 <- TeamData %>% select(ESPNRating,X2014HF,X2015HF,X2016HF,Market)

TeamDataKM2016 <- scale(TeamDataKM2016)

# Determine number of clusters
# wss <- (nrow(TeamDataKM)-1)*sum(apply(TeamDataKM,2,var))
# for (i in 2:15) wss[i] <- sum(kmeans(TeamDataKM,
#   	centers=i)$withinss)
# plot(1:15, wss, type="b", xlab="Number of Clusters",
#   ylab="Within groups sum of squares")

fit <- kmeans(TeamDataKM2016, 2)

TeamDataKM2016 <- data.frame(TeamDataKM2016, fit$cluster)

TeamData2016 <- data.frame(TeamData, fit$cluster)

rownames(TeamData2016) <- paste(TeamData2016$Sport,TeamData2016$Team,sep="")

clusplot(TeamData2016, fit$cluster, color=TRUE, shade=FALSE, 
  	labels=2, lines=0, cex.txt = .5,col.clus = c("red", "green"),col.txt = c("black", "black"))

TeamData2016 %>% group_by(TeamData2016$fit.cluster) %>% summarise(count=n(),MeanX2014HF = digits(mean(X2014HF),1),MeanX2015HF = digits(mean(X2015HF),1),MeanX2016HF = digits(mean(X2016HF),1),MeanPopulation = digits(mean(PopulationMil),1),MeanESPNRating = digits(mean(ESPNRating),1)) %>% kable() %>% kable_styling(c("striped","condensed"), full_width = F) %>% column_spec(column = 1:2, color = "black")

TeamData2015 <- TeamData

TeamDataKM2015 <- TeamData %>% select(ESPNRating,X2014HF,X2015HF,Market)

TeamDataKM2015 <- scale(TeamDataKM2015)

# Determine number of clusters
# wss <- (nrow(TeamDataKM)-1)*sum(apply(TeamDataKM,2,var))
# for (i in 2:15) wss[i] <- sum(kmeans(TeamDataKM,
#   	centers=i)$withinss)
# plot(1:15, wss, type="b", xlab="Number of Clusters",
#   ylab="Within groups sum of squares")

fit <- kmeans(TeamDataKM2015, 2)

TeamDataKM2015 <- data.frame(TeamDataKM2015, fit$cluster)

TeamData2015 <- data.frame(TeamData, fit$cluster)

rownames(TeamData2015) <- paste(TeamData2015$Sport,TeamData2015$Team,sep="")

clusplot(TeamData2015, fit$cluster, color=TRUE, shade=FALSE, 
  	labels=2, lines=0, cex.txt = .5,col.clus = c("red", "green"),col.txt = c("black", "black"))

TeamData2015 %>% group_by(TeamData2015$fit.cluster) %>% summarise(count=n(),MeanX2014HF = digits(mean(X2014HF),1),MeanX2015HF = digits(mean(X2015HF),1),MeanPopulation = digits(mean(PopulationMil),1),MeanESPNRating = digits(mean(ESPNRating),1)) %>% kable() %>% kable_styling(c("striped","condensed"), full_width = F) %>% column_spec(column = 1:2, color = "black")
```
```{r K-Means over time}

ESPNAnalytics <- data.frame("Year" = c(2015,2016,2017,2018),"High" = c(4.0,3.7,3.8,3.3),"Low" = c(2.2,2.9,2.9,2.3))

ESPNAnalytics %>% ggplot() +
  geom_line(aes(x=Year, y=High, color="Green")) +
  geom_line(aes(x=Year, y=Low), color="Dark Blue") +
  scale_x_continuous(breaks = seq(2015,2018, by=1)) +
  scale_y_continuous(limits = c(0,5)) +
  ylab("Mean K-Means Group ESPNAnalytics Score") +
  theme(legend.position="none") 
```

